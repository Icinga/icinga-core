<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>TCP Wrapper Integration</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.75.1">
<meta name="keywords" content="Supervision, Icinga, Nagios, Linux">
<link rel="home" href="index.html" title="Icinga Version 1.7 Documentation">
<link rel="up" href="ch09.html" title="Chapter 9. Integration With Other Software">
<link rel="prev" href="int-snmptrap.html" title="SNMP Trap Integration">
<link rel="next" href="int-mklivestatus.html" title="MKLiveStatus Integration">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<CENTER><IMG src="../images/logofullsize.png" border="0" alt="Icinga" title="Icinga"></CENTER>
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">TCP Wrapper Integration</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="int-snmptrap.html">Prev</a> </td>
<th width="60%" align="center">Chapter 9. Integration With Other Software</th>
<td width="20%" align="right"> <a accesskey="n" href="int-mklivestatus.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="section" title="TCP Wrapper Integration">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="int-tcpwrappers"></a><a name="int_tcpwrappers"></a>TCP Wrapper Integration</h2></div></div></div>
  

  <p><span class="bold"><strong>Introduction</strong></span></p>

  <p><span class="inlinemediaobject"><img src="../images/tcpwrappers.png"></span></p>

  <p>This document explains how to easily generate alerts in Icinga for connection attempts that are rejected by TCP
  wrappers. For example, if an unauthorized host attempts to connect to your SSH server, you can receive an alert in Icinga
  that contains the name of the host that was rejected. If you implement this on your Linux/Unix boxes, you'll be surprised how
  many port scans you can detect across your network.</p>

  <p>These directions assume:</p>

  <div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
      <p>You are already familiar with <a class="link" href="passivechecks.html" title="Passive Checks">passive checks</a> and how they work.</p>
    </li>
<li class="listitem">
      <p>You are already familiar with <a class="link" href="volatileservices.html" title="Volatile Services">volatile services</a> and how they work.</p>
    </li>
<li class="listitem">
      <p>The host which you are generating alerts for (i.e. the host you are using TCP wrappers on) is a remote host (called
      <span class="emphasis"><em>firestorm</em></span> in this example). If you want to generate alerts on the same host that Icinga is
      running you will need to make a few modifications to the examples we provide.</p>
    </li>
<li class="listitem">
      <p>You have installed the <a class="link" href="addons.html#addons-nsca">NSCA daemon</a> on your monitoring server and the NSCA client
      (<span class="emphasis"><em>send_nsca</em></span>) on the remote machine that you are generating TCP wrapper alerts from.</p>
    </li>
</ol></div>

  <p><span class="bold"><strong>Defining A Service</strong></span></p>

  <p>If you haven't done so already, create a <a class="link" href="objectdefinitions.html#objectdefinitions-host">host definition</a> for the remote host
  (<span class="emphasis"><em>firestorm</em></span>).</p>

  <p>Next, define a service in one of your <a class="link" href="configobject.html" title="Object Configuration Overview">object configuration files</a> for the TCP wrapper
  alerts on host <span class="emphasis"><em>firestorm</em></span>. The service definition might look something like this:</p>

  <pre class="screen"> define service{
        host_name                       firestorm
        service_description             TCP Wrappers
        is_volatile                     1
        active_checks_enabled           0
        passive_checks_enabled          1
        max_check_attempts              1
        check_command                   check_none
        ...
        }</pre>

  <p>There are some important things to note about the above service definition:</p>

  <div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
      <p>The <span class="emphasis"><em>volatile</em></span> option is enabled. We want this option enabled because we want a notification to be
      generated for every alert that comes in.</p>
    </li>
<li class="listitem">
      <p>Active checks of the service as disabled, while passive checks are enabled. This means that the service will never be
      actively checked by Icinga - all alert information will have to be received passively from an external source.</p>
    </li>
<li class="listitem">
      <p>The <span class="emphasis"><em>max_check_attempts</em></span> value is set to 1. This guarantees you will get a notification when the
      first alert is generated.</p>
    </li>
</ol></div>

  <p><span class="bold"><strong>Configuring TCP Wrappers</strong></span></p>

  <p>Now you're going to have to modify the <span class="emphasis"><em>/etc/hosts.deny</em></span> file on <span class="emphasis"><em>firestorm</em></span>. In
  order to have the TCP wrappers send an alert to the monitoring host whenever a connection attempt is denied, you'll have to add
  a line similiar to the following:</p>

  <pre class="screen"> ALL: ALL: RFC931: twist (/usr/local/icinga/libexec/eventhandlers/handle_tcp_wrapper %h %d) &amp;</pre>

  <p>This line assumes that there is a script called <span class="emphasis"><em>handle_tcp_wrapper</em></span> in the
  <span class="emphasis"><em>/usr/local/icinga/libexec/eventhandlers/</em></span> directory on <span class="emphasis"><em>firestorm</em></span>. We'll write that
  script next.</p>

  <p><span class="bold"><strong>Writing The Script</strong></span></p>

  <p>The last thing you need to do is write the <span class="emphasis"><em>handle_tcp_wrapper</em></span> script on
  <span class="emphasis"><em>firestorm</em></span> that will send the alert back to the Icinga server. It might look something like
  this:</p>

  <pre class="screen">#!/bin/sh

/usr/local/icinga/libexec/eventhandlers/submit_check_result firestorm "TCP Wrappers" 2 "Denied $2-$1" &gt; /dev/null 2&gt; /dev/null</pre>

  <p>Notice that the <span class="emphasis"><em>handle_tcp_wrapper</em></span> script calls the <span class="emphasis"><em>submit_check_result</em></span> script
  to actually send the alert back to the monitoring host. Assuming your Icinga server is called
  <span class="emphasis"><em>monitor</em></span>, the <span class="emphasis"><em>submit check_result</em></span> script might look like this:</p>

  <pre class="screen">#!/bin/sh
# Arguments
#       $1 = name of host in service definition
#       $2 = name/description of service in service definition
#       $3 = return code
#       $4 = output

/bin/echo -e "$1\t$2\t$3\t$4\n" | /usr/local/icinga/bin/send_nsca monitor -c /usr/local/nagios/etc/send_nsca.cfg</pre>

  <p><span class="bold"><strong>Finishing Up</strong></span></p>

  <p>You've now configured everything you need to, so all you have to do is restart the <span class="emphasis"><em>inetd</em></span> process on
  <span class="emphasis"><em>firestorm</em></span> and restart Icinga on your monitoring server. That's it! When the TCP wrappers on
  <span class="emphasis"><em>firestorm</em></span> deny a connection attempt, you should be getting alerts in Icinga. The plugin output for
  the alert will look something like the following:</p>

  <pre class="screen">Denied sshd2-sdn-ar-002mnminnP321.dialsprint.net </pre>
  <a class="indexterm" name="id1538762"></a>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="int-snmptrap.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="ch09.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="int-mklivestatus.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">SNMP Trap Integration </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> MKLiveStatus Integration</td>
</tr>
</table>
</div>
<P class="copyright">© 2009-2012 Icinga Development Team, http://www.icinga.org</P>
</body>
</html>
